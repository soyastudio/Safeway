- soya.framework.tools.xmlbeans.XmlSchemaBaseLoader:
    source: "D:/Workshop/Repository/CMM/BOD/GetGroceryOrder.xsd"

- soya.framework.tools.xmlbeans.XlsxMappingAnnotator:
    sourceFiles:
      - D:/Workshop/Repository/BusinessObjects/GroceryOrder/requirement/echo.json

    mappingFile: D:/Workshop/Repository/BusinessObjects/GroceryOrder/requirement/GroceryOrder_ERUMS_to_Canonical_Mapping_v1.4.2.xlsx
    sourceSheet:
      - "erums_to_edis_sample_payload"
      - "WYSIWYG_edis_sample_payload"

    mappingSheet: "Mapping Source to Canonical"
    excludes:
      - GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/Address/PhoneNbr
      - GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/GroceryOrderProfileType
      - GetGroceryOrder/GroceryOrderData/GrocerySubOrder/DeliveryPromotion
      - GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/PromotionTxt
      - GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/PromotionalDsc
      - GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/PromotionPriceAmt

- soya.framework.tools.xmlbeans.NodeMappingFixAnnotator:
    nodeFixes:
      GetGroceryOrder/DocumentData/Document:
        namespaceURI: http://collab.safeway.com/it/architecture/info/default.aspx
      GetGroceryOrder/DocumentData/DocumentAction:
        namespaceURI: http://collab.safeway.com/it/architecture/info/default.aspx

    targetPathFixes:
      GetGroceryOrder/DocumentData/Document/SystemEnvironmentCd: GetGroceryOrder/DocumentData/Document/@SystemEnvironmentCd
      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/PhoneFaxContact/TypeCode: GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/PhoneFaxContact/@TypeCode
      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/DigitalContact/EmailStatuses/typeCode: GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/DigitalContact/EmailStatuses/@typeCode
      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/DeliveryInfo/DeliverytimeZoneCd: GetGroceryOrder/GroceryOrderData/GrocerySubOrder/DeliveryInfo/DeliveryTimeZoneCd
      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/CustomerService/PhoneFaxContact/TypeCode: GetGroceryOrder/GroceryOrderData/GrocerySubOrder/CustomerService/PhoneFaxContact/@TypeCode

    sourcePathFixes:
      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/Address/PostalZoneCd: customer/address[*]/zipCode

- soya.framework.tools.xmlbeans.MappingsAnnotator:
    globalVariables:
      - name: VERSION_ID
        type: CHARACTER
        defaultValue: "'1.4.0.017'"
      - name: SYSTEM_ENVIRONMENT_CODE
        type: CHARACTER
        defaultValue: "'PROD'"

    mappings:
      GetGroceryOrder/DocumentData/Document/@VersionId:
        mapping:
          assignment: VERSION_ID

      GetGroceryOrder/DocumentData/Document/@SystemEnvironmentCd:
        mapping:
          assignment: SYSTEM_ENVIRONMENT_CODE

      GetGroceryOrder/DocumentData/Document/DocumentID:
        mapping:
          assignment: "'GROCERY_ORDER'"

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/FulfillingFacility:
        procedure: ConstructFulfillingFacility(_inputRootNode, FulfillingFacility_, GroceryOrderHeader_)

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact:
        loop:
          - sourcePath: customer/contact[*]
            name: contact
            variable: _contact

          - sourcePath: customer/email[*]
            name: email
            variable: _email

          - sourcePath: customer/address[*]
            name: address
            variable: _address

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/Contact/Address/PostalZoneCd:
        mapping:
          mappingRule: Direct Mapping
          sourcePath: customer/address[*]/zipCode

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/CustomerPreference:
        loop:
          - sourcePath: customer/preference/optIn[*]
            name: optIn
            variable: _optIn

        condition: _optIn.isOptin = 'true'

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/CustomerPreference/PreferenceType/Code:
        mapping:
          sourcePath: customer/preference/optIn[*]/type
          mappingRule: Direct Mapping

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerPayment/Tender:
        loop:
          - sourcePath: paymentDetails[*]
            name: paymentDetails
            variable: _paymentDetails

          - sourcePath: tender[*]
            name: tender
            variable: _tender

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerPayment/Tender/Refund:
        condition: _tender.tenderType = 'REFUND'

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerPayment/Tender/Cancellation:
        condition: _tender.tenderType = 'CANCELLATION'

      GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerSavings/SavingsCategoryType:
        loop:
          - sourcePath: orderTotal/cardSavings[*]
            name: card_savings
            variable: _card_savings

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder:
        loop:
          - sourcePath: subOrders[*]
            name: subOrder
            variable: _subOrder

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail:
        loop:
          - sourcePath: subOrders[*]/orderLines[*]
            name: orderLine
            variable: _orderLine

          - sourcePath: subOrders[*]/promoCodes[*]
            name: promoCode
            variable: _promoCode

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/ItemId/InternalItemId:
        mapping:
          mappingRule: Direct Mapping
          sourcePath: subOrders[*]/orderLines[*]/itemPrice/itemCode

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/ItemId/BaseProductNbr:
        mapping:
          mappingRule: Direct Mapping
          sourcePath: subOrders[*]/orderLines[*]/itemId

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/ReturnedItem:
        loop:
          - sourcePath: subOrders[*]/refundedOrderLines[*]
            name: refundedOrderLine
            variable: _refundedOrderLine

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/ChargeInfo:
        loop:
          - sourcePath: subOrders[*]/charges[*]
            name: charge
            variable: _charge

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/CustomerService:
        loop:
          - sourcePath: subOrders[*]/customerService/contact[*]
            name: service_contact
            variable: _service_contact

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/CustomerOffers:
        loop:
          - sourcePath: subOrders[*]/orderLines[*]/itemPrice/savings[*]
            name: customer_savings_loop
            variable: _customer_savings

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/GroceryOrderDetail/CustomerOffers/CustomerRewards:
        loop:
          - sourcePath: subOrders[*]/orderLines[*]/itemPrice/savings[*]/points[*]
            name: points_loop
            variable: _point

      GetGroceryOrder/GroceryOrderData/GrocerySubOrder/DeliveryInfo/DeliveryTimeZoneCd:
        mapping:
          assignment: _subOrder.deliveryInfo.slotInfo.timeZone

- soya.framework.tools.xmlbeans.AssignmentAnnotator:
    assignments:
      - GetGroceryOrder/DocumentData/Document/AlternateDocumentID: "'OSMS-EMOM_C02_ORDER-' || CAST(CURRENT_TIMESTAMP AS CHARACTER FORMAT 'YYYYMMddHHmmssSSSSSS')"
      - GetGroceryOrder/DocumentData/Document/DocumentNm: "'GroceryOrder'"
      - GetGroceryOrder/DocumentData/Document/CreationDt: CURRENT_TIMESTAMP

      - GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerPayment/Tender/RequiredAuthAmt: CAST($$ AS DECIMAL(10, 2))
      - GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/CustomerPayment/Tender/ExpireMonthYearTxt: _paymentDetails.cardExpiryMonth
      - GetGroceryOrder/GroceryOrderData/GrocerySubOrder/ChargeInfo/ChargeAmt: CAST($$ AS DECIMAL(10, 2))

- soya.framework.tools.xmlbeans.DecimalFunctionAnnotator:

- soya.framework.tools.xmlbeans.NodeBuildAnnotator:
    path: GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/CustomerSubscription
    block:
      - "IF _inputRootNode.customer.isSubscription = 'true' THEN"
      - ""
      - "+ -- GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/CustomerSubscription/SubscriptionTypeCd"
      - "+ SET CustomerSubscription_.(XMLNSC.Field)Abs:SubscriptionTypeCd = 'Subscription';"
      - ""
      - "+ -- GetGroceryOrder/GroceryOrderData/GroceryOrderHeader/RetailCustomer/CustomerSubscription/OptInInd"
      - "+ SET CustomerSubscription_.(XMLNSC.Field)Abs:OptInInd = 'true';"
      - ""
      - "ELSE"
      - ""
      - "+ SET CustomerSubscription_.(XMLNSC.Field)Abs:OptInInd = 'false';"
      - ""
      - "END IF;"

- soya.framework.tools.xmlbeans.SampleXmlRenderer:

- soya.framework.tools.xmlbeans.XPathRenderer:
    printUnmapped: true

- soya.framework.tools.xmlbeans.XmlConstructTreeRenderer:

- soya.framework.tools.xmlbeans.BaseAnnotationRenderer:
    name: UnknownMappings
    annotation: UNKNOWN_MAPPINGS

- soya.framework.tools.xmlbeans.JsonMappingRenderer:
- soya.framework.tools.xmlbeans.LoopAnalyzeRenderer:
- soya.framework.tools.xmlbeans.AvroSchemaRenderer:

- soya.framework.tools.xmlbeans.XmlConstructEsqlRenderer:
    brokerSchema: com.abs.erums.groceryorder
    moduleName: ESED_GroceryOrder_CMM_Transformer_Compute
    inputRootVariable: _inputRootNode
    inputRootReference: InputRoot.JSON.Data
